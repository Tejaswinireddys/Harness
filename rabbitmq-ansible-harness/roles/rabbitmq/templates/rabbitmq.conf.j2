# RabbitMQ 4.x Configuration File
# Generated by Harness CD Pipeline
# Timestamp: {{ ansible_date_time.iso8601 }}
# Node: {{ inventory_hostname }}
# Environment: {{ environment_name | default('unknown') }}

## ═══════════════════════════════════════════════════════════
## CLUSTER CONFIGURATION
## ═══════════════════════════════════════════════════════════

cluster_name = {{ rabbitmq_cluster_name }}
cluster_partition_handling = {{ rabbitmq_cluster_partition_handling | default('pause_minority') }}

# Peer discovery configuration
cluster_formation.peer_discovery_backend = classic_config
{% for node in groups['rabbitmq_cluster'] %}
cluster_formation.classic_config.nodes.{{ loop.index }} = rabbit@{{ node }}
{% endfor %}

## ═══════════════════════════════════════════════════════════
## NETWORKING
## ═══════════════════════════════════════════════════════════

# AMQP listeners
{% for listener in rabbitmq_listeners %}
listeners.tcp.{{ loop.index }} = {{ listener.ip | default('::') }}:{{ listener.port }}
{% endfor %}

# Management UI
management.tcp.port = {{ rabbitmq_management_listener.port | default(15672) }}
management.tcp.ip = {{ rabbitmq_management_listener.ip | default('::') }}

# Prometheus metrics
prometheus.tcp.port = {{ rabbitmq_prometheus_port | default(15692) }}

{% if rabbitmq_ssl_enabled | default(false) %}
## ═══════════════════════════════════════════════════════════
## TLS/SSL CONFIGURATION
## ═══════════════════════════════════════════════════════════

listeners.ssl.default = {{ rabbitmq_ssl_port | default(5671) }}
ssl_options.cacertfile = {{ rabbitmq_ssl_cacertfile }}
ssl_options.certfile = {{ rabbitmq_ssl_certfile }}
ssl_options.keyfile = {{ rabbitmq_ssl_keyfile }}
ssl_options.verify = {{ rabbitmq_ssl_verify | default('verify_peer') }}
ssl_options.fail_if_no_peer_cert = {{ rabbitmq_ssl_fail_if_no_peer_cert | default('false') }}
ssl_options.versions.1 = tlsv1.3
ssl_options.versions.2 = tlsv1.2
{% endif %}

## ═══════════════════════════════════════════════════════════
## RESOURCE LIMITS
## ═══════════════════════════════════════════════════════════

# Memory watermarks
vm_memory_high_watermark.relative = {{ rabbitmq_vm_memory_high_watermark | default(0.6) }}
vm_memory_high_watermark_paging_ratio = {{ rabbitmq_vm_memory_high_watermark_paging_ratio | default(0.5) }}

# Disk free limit
disk_free_limit.absolute = {{ rabbitmq_disk_free_limit | default('2GB') }}

# Channel limits
channel_max = {{ rabbitmq_channel_max | default(2047) }}

# Maximum message size (RabbitMQ 4.x)
max_message_size = {{ rabbitmq_max_message_size | default(134217728) }}

## ═══════════════════════════════════════════════════════════
## QUEUE CONFIGURATION (RabbitMQ 4.x)
## ═══════════════════════════════════════════════════════════

# Default queue type (quorum recommended for 4.x)
default_queue_type = {{ rabbitmq_default_queue_type | default('quorum') }}

# Quorum queue settings
quorum_queue.default_delivery_limit = {{ rabbitmq_quorum_queue_default_delivery_limit | default(20) }}

# Consumer timeout (in milliseconds)
consumer_timeout = {{ rabbitmq_consumer_timeout | default(1800000) }}

## ═══════════════════════════════════════════════════════════
## TCP SETTINGS
## ═══════════════════════════════════════════════════════════

tcp_listen_options.backlog = {{ rabbitmq_tcp_listen_options.backlog | default(4096) }}
tcp_listen_options.nodelay = {{ rabbitmq_tcp_listen_options.nodelay | default('true') }}
tcp_listen_options.linger.on = {{ rabbitmq_tcp_listen_options.linger_on | default('true') }}
tcp_listen_options.linger.timeout = {{ rabbitmq_tcp_listen_options.linger_timeout | default(0) }}
tcp_listen_options.sndbuf = {{ rabbitmq_tcp_listen_options.sndbuf | default(196608) }}
tcp_listen_options.recbuf = {{ rabbitmq_tcp_listen_options.recbuf | default(196608) }}

## ═══════════════════════════════════════════════════════════
## LOGGING
## ═══════════════════════════════════════════════════════════

log.file = {{ rabbitmq_log_file | default('/var/log/rabbitmq/rabbitmq.log') }}
log.file.level = {{ rabbitmq_log_level | default('info') }}
log.console = true
log.console.level = {{ rabbitmq_log_level | default('info') }}

{% if rabbitmq_log_rotation.enabled | default(true) %}
log.file.rotation.count = {{ rabbitmq_log_rotation.count | default(10) }}
log.file.rotation.size = {{ rabbitmq_log_rotation.size | default(10485760) }}
{% endif %}

## ═══════════════════════════════════════════════════════════
## AUTHENTICATION & AUTHORIZATION
## ═══════════════════════════════════════════════════════════

# Disable guest user remote access
loopback_users.guest = true

# Auth backends
auth_backends.1 = internal

## ═══════════════════════════════════════════════════════════
## MANAGEMENT PLUGIN SETTINGS
## ═══════════════════════════════════════════════════════════

management.load_definitions = /etc/rabbitmq/definitions.json
management.sample_retention_policies.global.minute = 5
management.sample_retention_policies.global.hour = 60
management.sample_retention_policies.global.day = 1200
management.sample_retention_policies.basic.minute = 5
management.sample_retention_policies.basic.hour = 60
management.sample_retention_policies.detailed.10 = 5

## ═══════════════════════════════════════════════════════════
## BACKGROUND GC
## ═══════════════════════════════════════════════════════════

background_gc_enabled = true
background_gc_target_interval = 60000

## ═══════════════════════════════════════════════════════════
## DISTRIBUTION CONFIGURATION
## ═══════════════════════════════════════════════════════════

# Erlang distribution
distribution.listener.port_range.min = 25672
distribution.listener.port_range.max = 25672

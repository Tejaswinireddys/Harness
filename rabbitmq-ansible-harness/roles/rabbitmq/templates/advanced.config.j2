%% RabbitMQ Advanced Configuration
%% Generated by Harness CD Pipeline
%% Timestamp: {{ ansible_date_time.iso8601 }}
%% Node: {{ inventory_hostname }}

[
  {rabbit, [
    %% Cluster partition handling
    {cluster_partition_handling, {{ rabbitmq_cluster_partition_handling | default('pause_minority') }}},
    
    %% TCP listeners configuration
    {tcp_listeners, [
{% for listener in rabbitmq_listeners %}
      {"{{ listener.ip | default('::') }}", {{ listener.port }}}{% if not loop.last %},{% endif %}
      
{% endfor %}
    ]},
    
    %% Erlang distribution port
    {distribution, [
      {port_range, {25672, 25672}}
    ]},
    
    %% Memory and disk alarms
    {vm_memory_high_watermark, {{ rabbitmq_vm_memory_high_watermark | default(0.6) }}},
    {disk_free_limit, "{{ rabbitmq_disk_free_limit | default('2GB') }}"},
    
    %% Connection and channel limits
    {channel_max, {{ rabbitmq_channel_max | default(2047) }}},
    
    %% Message TTL defaults
    {message_ttl, 86400000},
    
    %% Handshake timeout
    {handshake_timeout, 60000},
    
    %% Default vhost
    {default_vhost, <<"/">>},
    
    %% Default user (disabled for security)
    {default_user, <<"guest">>},
    {default_pass, <<"guest">>},
    {default_permissions, [<<".*">>, <<".*">>, <<".*">>]},
    {default_user_tags, [administrator]},
    
    %% Loopback users (only allow guest from localhost)
    {loopback_users, [<<"guest">>]}
  ]},
  
  {rabbitmq_management, [
    {listener, [
      {port, {{ rabbitmq_management_listener.port | default(15672) }}},
      {ip, "{{ rabbitmq_management_listener.ip | default('::') }}"}
    ]},
    
    %% HTTP API CORS
    {cors_allow_origins, [<<"*">>]},
    
    %% Sample retention
    {sample_retention_policies, [
      {global, [{60, 5}, {3600, 60}, {86400, 1200}]},
      {basic, [{60, 5}, {3600, 60}]},
      {detailed, [{10, 5}]}
    ]}
  ]},
  
  {rabbitmq_prometheus, [
    {tcp_config, [
      {port, {{ rabbitmq_prometheus_port | default(15692) }}}
    ]}
  ]},
  
  {kernel, [
    %% Increase distribution buffer size for large clusters
    {inet_dist_listen_min, 25672},
    {inet_dist_listen_max, 25672}
  ]}
].

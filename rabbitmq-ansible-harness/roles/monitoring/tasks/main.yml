# Monitoring Role - Prometheus and Observability Setup
---
- name: Display monitoring role banner
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════
      MONITORING ROLE - Observability Setup
      Node: {{ inventory_hostname }}
      Prometheus: {{ monitoring.prometheus_enabled | default(true) }}
      Node Exporter: {{ monitoring.node_exporter_enabled | default(true) }}
      ════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════
# PROMETHEUS RABBITMQ PLUGIN VERIFICATION
# ═══════════════════════════════════════════════════════════
- name: Verify rabbitmq_prometheus plugin is enabled
  ansible.builtin.command: rabbitmq-plugins list --enabled
  register: enabled_plugins
  changed_when: false

- name: Assert prometheus plugin is enabled
  ansible.builtin.assert:
    that:
      - "'rabbitmq_prometheus' in enabled_plugins.stdout"
    fail_msg: "❌ rabbitmq_prometheus plugin is not enabled"
    success_msg: "✅ rabbitmq_prometheus plugin is enabled"

- name: Test Prometheus metrics endpoint
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ monitoring.prometheus_port | default(15692) }}/metrics"
    method: GET
    status_code: 200
    return_content: no
  register: prometheus_test
  retries: 3
  delay: 5
  until: prometheus_test.status == 200

- name: Display Prometheus endpoint status
  ansible.builtin.debug:
    msg: "✅ Prometheus metrics available at http://{{ ansible_host }}:{{ monitoring.prometheus_port | default(15692) }}/metrics"

# ═══════════════════════════════════════════════════════════
# NODE EXPORTER (Optional)
# ═══════════════════════════════════════════════════════════
- name: Install Node Exporter
  block:
    - name: Check if node_exporter is installed
      ansible.builtin.stat:
        path: /usr/local/bin/node_exporter
      register: node_exporter_stat

    - name: Download Node Exporter
      ansible.builtin.get_url:
        url: "https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz"
        dest: /tmp/node_exporter.tar.gz
        mode: '0644'
      when: not node_exporter_stat.stat.exists

    - name: Extract Node Exporter
      ansible.builtin.unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp/
        remote_src: yes
      when: not node_exporter_stat.stat.exists

    - name: Install Node Exporter binary
      ansible.builtin.copy:
        src: /tmp/node_exporter-1.7.0.linux-amd64/node_exporter
        dest: /usr/local/bin/node_exporter
        remote_src: yes
        mode: '0755'
      when: not node_exporter_stat.stat.exists

    - name: Create node_exporter user
      ansible.builtin.user:
        name: node_exporter
        system: yes
        shell: /usr/sbin/nologin
        create_home: no

    - name: Create Node Exporter systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Node Exporter
          Wants=network-online.target
          After=network-online.target

          [Service]
          User=node_exporter
          Group=node_exporter
          Type=simple
          ExecStart=/usr/local/bin/node_exporter --web.listen-address=:{{ monitoring.node_exporter_port | default(9100) }}
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/node_exporter.service
        mode: '0644'

    - name: Start and enable Node Exporter
      ansible.builtin.systemd:
        name: node_exporter
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Wait for Node Exporter to be ready
      ansible.builtin.wait_for:
        port: "{{ monitoring.node_exporter_port | default(9100) }}"
        host: "{{ ansible_host }}"
        timeout: 30

    - name: Display Node Exporter status
      ansible.builtin.debug:
        msg: "✅ Node Exporter running at http://{{ ansible_host }}:{{ monitoring.node_exporter_port | default(9100) }}/metrics"
  when: monitoring.node_exporter_enabled | default(true)

# ═══════════════════════════════════════════════════════════
# ALERTING RULES (Generate for Prometheus)
# ═══════════════════════════════════════════════════════════
- name: Create alerting rules directory
  ansible.builtin.file:
    path: /etc/rabbitmq/alerting
    state: directory
    owner: rabbitmq
    group: rabbitmq
    mode: '0755'

- name: Generate Prometheus alerting rules
  ansible.builtin.copy:
    content: |
      # RabbitMQ Prometheus Alerting Rules
      # Generated by Harness CD Pipeline
      # Copy this to your Prometheus server
      
      groups:
        - name: rabbitmq
          rules:
            - alert: RabbitMQNodeDown
              expr: up{job="rabbitmq"} == 0
              for: 1m
              labels:
                severity: critical
              annotations:
                summary: "RabbitMQ node {{ '{{' }} $labels.instance {{ '}}' }} is down"
                description: "RabbitMQ node has been down for more than 1 minute"

            - alert: RabbitMQHighMemory
              expr: rabbitmq_process_resident_memory_bytes / rabbitmq_resident_memory_limit_bytes > 0.8
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "RabbitMQ memory usage above 80%"
                description: "Memory usage is {{ '{{' }} $value | humanizePercentage {{ '}}' }}"

            - alert: RabbitMQHighDisk
              expr: rabbitmq_disk_space_available_bytes / rabbitmq_disk_space_available_limit_bytes < 0.2
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "RabbitMQ disk space below 20%"

            - alert: RabbitMQQueueGrowing
              expr: rate(rabbitmq_queue_messages_total[5m]) > 100
              for: 10m
              labels:
                severity: warning
              annotations:
                summary: "Queue {{ '{{' }} $labels.queue {{ '}}' }} is growing rapidly"

            - alert: RabbitMQNoConsumers
              expr: rabbitmq_queue_consumers == 0 and rabbitmq_queue_messages > 0
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "Queue {{ '{{' }} $labels.queue {{ '}}' }} has messages but no consumers"

            - alert: RabbitMQClusterPartition
              expr: rabbitmq_cluster_partitions > 0
              for: 1m
              labels:
                severity: critical
              annotations:
                summary: "RabbitMQ cluster partition detected"

            - alert: RabbitMQTooManyConnections
              expr: rabbitmq_connections > 1000
              for: 5m
              labels:
                severity: warning
              annotations:
                summary: "RabbitMQ has too many connections"
    dest: /etc/rabbitmq/alerting/prometheus_rules.yml
    owner: rabbitmq
    group: rabbitmq
    mode: '0644'
  run_once: true
  delegate_to: "{{ rabbitmq_primary_node }}"

# ═══════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════
- name: Monitoring role summary
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════
      ✅ MONITORING ROLE COMPLETED
      ════════════════════════════════════════════════════════
      Prometheus Metrics: http://{{ ansible_host }}:{{ monitoring.prometheus_port | default(15692) }}/metrics
      {% if monitoring.node_exporter_enabled | default(true) %}
      Node Exporter: http://{{ ansible_host }}:{{ monitoring.node_exporter_port | default(9100) }}/metrics
      {% endif %}
      Alerting Rules: /etc/rabbitmq/alerting/prometheus_rules.yml
      ════════════════════════════════════════════════════════

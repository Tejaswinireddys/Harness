# Production Environment Variables
# RabbitMQ 4.x Cluster Configuration
# ⚠️ PRODUCTION - All changes require approval
---
# Environment Configuration
environment_name: production
environment_short: prod
deployment_env: production

# RabbitMQ Configuration
rabbitmq_version: "4.0.3"
rabbitmq_release_series: "4.0"

# Erlang Configuration
erlang_version: "26.2"

# Cluster Configuration
rabbitmq_cluster_name: "rabbitmq-{{ environment_short }}-cluster"
rabbitmq_primary_node: "rabbitmq-prod-1"
rabbitmq_cluster_partition_handling: pause_minority

# Authentication (ALL secrets from environment/Harness)
erlang_cookie: "{{ lookup('env', 'ERLANG_COOKIE') }}"
rabbitmq_admin_user: admin
rabbitmq_admin_password: "{{ lookup('env', 'RABBITMQ_ADMIN_PASSWORD') }}"

# Virtual Hosts
rabbitmq_vhosts:
  - name: /
    state: present
  - name: /app
    state: present
  - name: /monitoring
    state: present
  - name: /integration
    state: present

# Users (passwords MUST come from secrets)
rabbitmq_users:
  - user: admin
    password: "{{ rabbitmq_admin_password }}"
    tags: administrator
    vhost: /
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present
  - user: app_user
    password: "{{ lookup('env', 'RABBITMQ_APP_PASSWORD') }}"
    tags: ""
    vhost: /app
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present
  - user: monitoring_user
    password: "{{ lookup('env', 'RABBITMQ_MONITORING_PASSWORD') }}"
    tags: monitoring
    vhost: /
    configure_priv: ""
    read_priv: .*
    write_priv: ""
    state: present

# Plugins
rabbitmq_plugins:
  - rabbitmq_management
  - rabbitmq_management_agent
  - rabbitmq_prometheus
  - rabbitmq_shovel
  - rabbitmq_shovel_management
  - rabbitmq_federation
  - rabbitmq_federation_management
  - rabbitmq_consistent_hash_exchange

# Resource Limits (Production optimized)
rabbitmq_vm_memory_high_watermark: 0.6
rabbitmq_vm_memory_high_watermark_paging_ratio: 0.5
rabbitmq_disk_free_limit: "10GB"
rabbitmq_channel_max: 2047
rabbitmq_max_message_size: 134217728

# Networking
rabbitmq_listeners:
  - port: 5672
    ip: "::"
rabbitmq_management_listener:
  port: 15672
  ip: "::"
  ssl: false
rabbitmq_prometheus_port: 15692

# TLS Configuration (enable for production)
rabbitmq_ssl_enabled: false  # Set to true when certs are available
rabbitmq_ssl_port: 5671

# TCP Settings (Production tuned)
rabbitmq_tcp_listen_options:
  backlog: 8192
  nodelay: true
  linger_on: true
  linger_timeout: 0
  sndbuf: 393216
  recbuf: 393216

# Logging
rabbitmq_log_level: warning
rabbitmq_log_file: /var/log/rabbitmq/rabbitmq.log
rabbitmq_log_rotation:
  enabled: true
  count: 20
  size: 52428800  # 50MB

# Queue Configuration
rabbitmq_default_queue_type: quorum
rabbitmq_quorum_queue_default_delivery_limit: 20
rabbitmq_consumer_timeout: 3600000  # 1 hour

# Policies (Production HA)
rabbitmq_policies:
  - name: ha-all
    pattern: "^(?!amq\\.).*"
    vhost: /
    definition:
      ha-mode: all
      ha-sync-mode: automatic
      ha-promote-on-shutdown: always
      queue-master-locator: min-masters
    priority: 0
    apply_to: queues
  - name: quorum-queues
    pattern: "^quorum\\."
    vhost: /
    definition:
      queue-type: quorum
      x-quorum-initial-group-size: 3
    priority: 1
    apply_to: queues
  - name: dlx-policy
    pattern: ".*"
    vhost: /app
    definition:
      dead-letter-exchange: dlx
    priority: 0
    apply_to: queues

# System Limits (Production high)
system_ulimits:
  nofile:
    soft: 131072
    hard: 131072
  nproc:
    soft: 65536
    hard: 65536

system_sysctl:
  net.core.somaxconn: 8192
  net.core.netdev_max_backlog: 8192
  net.ipv4.tcp_max_syn_backlog: 8192
  net.ipv4.tcp_fin_timeout: 15
  net.ipv4.tcp_keepalive_time: 600
  net.ipv4.tcp_keepalive_intvl: 60
  net.ipv4.tcp_keepalive_probes: 3
  net.ipv4.tcp_tw_reuse: 1
  vm.swappiness: 1

# Backup Configuration
rabbitmq_backup:
  enabled: true
  directory: /var/backups/rabbitmq
  retention_days: 30

# Monitoring
monitoring:
  prometheus_enabled: true
  prometheus_port: 15692
  node_exporter_enabled: true
  node_exporter_port: 9100
